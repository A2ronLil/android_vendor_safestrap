#!/system/bin/sh
# By: Hashcode and Edgan
# Version: 0.82
PATH=/system/xbin:/system/bin
OLDINITRC=/init.rc
REC_FILE=/preinstall/recovery/.recovery_mode
RECOVERY_DIR=/preinstall/recovery
BOOTMODE=$(getprop ro.bootmode)
MOUNTED_PREINSTALL=0
BOOTRECOVERY=0

#modes: ap-bp-bypass, bp-tools
if [ "$BOOTMODE" = "bp-tools" ]; then
	if [ ! -d "$RECOVERY_DIR" ]; then
		# mount preinstall
		MOUNTED_PREINSTALL=1
		mount -t ext3 /dev/block/preinstall /preinstall
	fi
	if [ -f "$REC_FILE" ]; then
		BOOTRECOVERY=1
	fi
	# check for .recovery_mode file and recovery dir
	if [ "$BOOTRECOVERY" = "0" ]; then
		if [ "$MOUNTED_PREINSTALL" = "1" ]; then
			busybox umount /preinstall
		fi
		/system/bin/logwrapper.orig "$@"
		exit
	fi

	# mount rootfs writeable
	mount -o remount,rw rootfs

	# recreate /tmp where it's not a symlink
	rm /tmp
	mkdir /tmp
	chmod 755 /tmp

	# recreate /etc where it's not a symlink
	rm /etc
	mkdir /etc
	chmod 755 /etc

	# make /res directories
	mkdir /res
	chmod 755 /res
	mkdir /res/images
	chmod 755 /res/images

	rm /sdcard
	rm /sdcard-ext
	rm -r /mnt
	rm /vendor
	rm /d
	
	# move apps into /tmp for execution later
	cp /system/xbin/taskset /sbin
	cp /system/bin/sync /sbin
	cp /system/bin/2nd-init /sbin

	# setup rootfs
	mv /sbin/adbd /sbin/adbd.old
	cp $RECOVERY_DIR/* /
	cp $RECOVERY_DIR/etc/* /etc
	cp $RECOVERY_DIR/res/* /res
	cp $RECOVERY_DIR/res/images/* /res/images
	cp $RECOVERY_DIR/sbin/* /sbin
	chmod 755 /sbin/*
	cd /sbin
	ln -s recovery busybox
	ln -s recovery dump_image
	ln -s recovery edify
	ln -s recovery erase_image
	ln -s recovery flash_image
	ln -s recovery mkyaffs2image
	ln -s recovery nandroid
	ln -s recovery reboot
	ln -s recovery unyaffs
	ln -s recovery volume
	for file in `./busybox --list`; do ln -s busybox "$file"; done

	/sbin/umount /preinstall
	/sbin/umount /data
	/sbin/umount /system
	/sbin/taskset -p -c 0 1
	/sbin/sync
	/sbin/taskset -c 0 /sbin/2nd-init
	exit
# // disabling 2nd-init for now
#	else
#			mount -o remount,rw rootfs /
#			cp -p $NEWINITRC /
#			cp -p $OLDCDMARC /
#			cp -p $OLDGSMRC /
#			taskset -p -c 0 1
#			sync
#			taskset -c 0 /system/bin/2nd-init
#		fi
fi

/system/bin/logwrapper.orig "$@"

